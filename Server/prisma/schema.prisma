

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}


model Company {
  id              Int             @id @default(autoincrement())
  name            String
  legalName       String?
  address         String?
  phone           String?
  email           String?
  taxId           String?
  currencyCode    String          @default("USD") @db.Char(3)
  fiscalYearEnd   DateTime?       @db.Date
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  accounts        Account[]
  customers       Customer[]
  vendors         Vendor[]
  products        Product[]
  journalEntries  JournalEntry[]
  invoices        Invoice[]
  bills           Bill[]
  payments        Payment[]
  bankTransactions BankTransaction[]
  taxRates        TaxRate[]
  fiscalPeriods   FiscalPeriod[]
}


model AccountType {
  id            Int       @id @default(autoincrement())
  name          String    @unique
  category      Category
  normalBalance Balance
  accounts      Account[]
}

enum Category {
  asset
  liability
  equity
  revenue
  expense
}

enum Balance {
  debit
  credit
}


model Account {
  id                    Int                  @id @default(autoincrement())
  companyId             Int
  company               Company              @relation(fields: [companyId], references: [id])
  accountNumber         String
  accountName                  String
  accountTypeId         Int?
  accountType           AccountType?         @relation(fields: [accountTypeId], references: [id])
  parentAccountId       Int?
  parentAccount         Account?             @relation("AccountHierarchy", fields: [parentAccountId], references: [id])
  childAccounts         Account[]            @relation("AccountHierarchy")
  description           String?
  isActive              Boolean              @default(true)
  isSystemAccount       Boolean              @default(false)
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt
  journalEntryLines     JournalEntryLine[]
  productsIncome        Product[]            @relation("IncomeAccount")
  productsExpense       Product[]            @relation("ExpenseAccount")
  billLines             BillLine[]
  bankTransactions      BankTransaction[]
  paymentsBank          Payment[]

  @@unique([companyId, accountNumber])
}


model Customer {
  id              Int       @id @default(autoincrement())
  name            String
  email           String?
  phone           String?
  billingAddress  String?
  shippingAddress String?
  taxId           String?
  paymentTerms    Int       @default(30)
  creditLimit     Decimal?  @db.Decimal(15, 2)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  companyId       Int
  company         Company   @relation(fields: [companyId], references: [id])
  customerNumber  String
  invoices        Invoice[]
  payments        Payment[]

  @@unique([companyId, customerNumber])
}


model Vendor {
  id             Int       @id @default(autoincrement())
  name           String
  email          String?
  phone          String?
  address        String?
  vendorNumber   String
  companyId      Int
  taxId          String?
  paymentTerms   Int       @default(30)
  isActive       Boolean   @default(true)
  company        Company   @relation(fields: [companyId], references: [id])
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  bills          Bill[]
  payments       Payment[]

  @@unique([companyId, vendorNumber])
}


model Product {
  id                Int           @id @default(autoincrement())
  companyId         Int
  company           Company       @relation(fields: [companyId], references: [id])
  sku               String?
  name              String
  description       String?
  type              ProductType?
  unitPrice         Decimal?      @db.Decimal(15, 2)
  cost              Decimal?      @db.Decimal(15, 2)
  incomeAccountId   Int?
  incomeAccount     Account?      @relation("IncomeAccount", fields: [incomeAccountId], references: [id])
  expenseAccountId  Int?
  expenseAccount    Account?      @relation("ExpenseAccount", fields: [expenseAccountId], references: [id])
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  invoiceLines      InvoiceLine[]
}

enum ProductType {
  product
  service
}


model JournalEntry {
  id                  Int                  @id @default(autoincrement())
  companyId           Int
  company             Company              @relation(fields: [companyId], references: [id])
  entryNumber         String
  entryDate           DateTime             @db.Date
  description         String?
  reference           String?
  status              JournalStatus        @default(draft)
  createdBy           Int?
  postedAt            DateTime?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  lines               JournalEntryLine[]
  invoices            Invoice[]
  bills               Bill[]
  payments            Payment[]
  bankTransactions    BankTransaction[]

  @@unique([companyId, entryNumber])
}

enum JournalStatus {
  draft
  posted
  void
}


model JournalEntryLine {
  id              Int           @id @default(autoincrement())
  journalEntryId  Int
  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  accountId       Int
  account         Account       @relation(fields: [accountId], references: [id])
  debitAmount     Decimal       @default(0) @db.Decimal(15, 2)
  creditAmount    Decimal       @default(0) @db.Decimal(15, 2)
  description     String?
  lineNumber      Int
  createdAt       DateTime      @default(now())
}


model Invoice {
  id               Int                  @id @default(autoincrement())
  companyId        Int
  company          Company              @relation(fields: [companyId], references: [id])
  customerId       Int
  customer         Customer             @relation(fields: [customerId], references: [id])
  invoiceNumber    String
  invoiceDate      DateTime             @db.Date
  dueDate          DateTime             @db.Date
  status           InvoiceStatus        @default(draft)
  subtotal         Decimal              @db.Decimal(15, 2)
  taxAmount        Decimal              @default(0) @db.Decimal(15, 2)
  totalAmount      Decimal              @db.Decimal(15, 2)
  amountPaid       Decimal              @default(0) @db.Decimal(15, 2)
  notes            String?
  journalEntryId   Int?
  journalEntry     JournalEntry?        @relation(fields: [journalEntryId], references: [id])
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  lines            InvoiceLine[]
  paymentAllocations PaymentAllocation[]

  @@unique([companyId, invoiceNumber])
}

enum InvoiceStatus {
  draft
  sent
  partial
  paid
  overdue
  void
}


model InvoiceLine {
  id          Int      @id @default(autoincrement())
  invoiceId   Int
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  productId   Int?
  product     Product? @relation(fields: [productId], references: [id])
  description String
  quantity    Decimal  @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(15, 2)
  taxRate     Decimal  @default(0) @db.Decimal(5, 2)
  lineTotal   Decimal  @db.Decimal(15, 2)
  lineNumber  Int
  createdAt   DateTime @default(now())
}


model Bill {
  id               Int                  @id @default(autoincrement())
  companyId        Int
  company          Company              @relation(fields: [companyId], references: [id])
  vendorId         Int
  vendor           Vendor               @relation(fields: [vendorId], references: [id])
  billNumber       String
  billDate         DateTime             @db.Date
  dueDate          DateTime             @db.Date
  status           BillStatus           @default(unpaid)
  subtotal         Decimal              @db.Decimal(15, 2)
  taxAmount        Decimal              @default(0) @db.Decimal(15, 2)
  totalAmount      Decimal              @db.Decimal(15, 2)
  amountPaid       Decimal              @default(0) @db.Decimal(15, 2)
  notes            String?
  journalEntryId   Int?
  journalEntry     JournalEntry?        @relation(fields: [journalEntryId], references: [id])
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  lines            BillLine[]
  paymentAllocations PaymentAllocation[]

  @@unique([companyId, billNumber])
}

enum BillStatus {
  unpaid
  partial
  paid
  void
}


model BillLine {
  id          Int      @id @default(autoincrement())
  billId      Int
  bill        Bill     @relation(fields: [billId], references: [id], onDelete: Cascade)
  accountId   Int
  account     Account  @relation(fields: [accountId], references: [id])
  description String
  quantity    Decimal  @default(1) @db.Decimal(10, 2)
  unitPrice   Decimal  @db.Decimal(15, 2)
  lineTotal   Decimal  @db.Decimal(15, 2)
  lineNumber  Int
  createdAt   DateTime @default(now())
}


model Payment {
  id                 Int                  @id @default(autoincrement())
  companyId          Int
  company            Company              @relation(fields: [companyId], references: [id])
  paymentNumber      String
  paymentDate        DateTime             @db.Date
  paymentType        PaymentType?
  customerId         Int?
  customer           Customer?            @relation(fields: [customerId], references: [id])
  vendorId           Int?
  vendor             Vendor?              @relation(fields: [vendorId], references: [id])
  amount             Decimal              @db.Decimal(15, 2)
  paymentMethod      String?
  referenceNumber    String?
  notes              String?
  bankAccountId      Int?
  bankAccount        Account?             @relation(fields: [bankAccountId], references: [id])
  journalEntryId     Int?
  journalEntry       JournalEntry?        @relation(fields: [journalEntryId], references: [id])
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  paymentAllocations PaymentAllocation[]

  @@unique([companyId, paymentNumber])
}

enum PaymentType {
  received
  sent
}


model PaymentAllocation {
  id        Int      @id @default(autoincrement())
  paymentId Int
  payment   Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  invoiceId Int?
  invoice   Invoice? @relation(fields: [invoiceId], references: [id])
  billId    Int?
  bill      Bill?    @relation(fields: [billId], references: [id])
  amount    Decimal  @db.Decimal(15, 2)
  createdAt DateTime @default(now())
}


model BankTransaction {
  id              Int           @id @default(autoincrement())
  companyId       Int
  company         Company       @relation(fields: [companyId], references: [id])
  bankAccountId   Int
  bankAccount     Account       @relation(fields: [bankAccountId], references: [id])
  transactionDate DateTime      @db.Date
  description     String?
  reference       String?
  debitAmount     Decimal       @default(0) @db.Decimal(15, 2)
  creditAmount    Decimal       @default(0) @db.Decimal(15, 2)
  balance         Decimal?      @db.Decimal(15, 2)
  isReconciled    Boolean       @default(false)
  reconciledAt    DateTime?
  journalEntryId  Int?
  journalEntry    JournalEntry? @relation(fields: [journalEntryId], references: [id])
  createdAt       DateTime      @default(now())
}


model TaxRate {
  id          Int      @id @default(autoincrement())
  companyId   Int
  company     Company  @relation(fields: [companyId], references: [id])
  name        String
  rate        Decimal  @db.Decimal(5, 2)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}


model FiscalPeriod {
  id        Int            @id @default(autoincrement())
  companyId Int
  company   Company        @relation(fields: [companyId], references: [id])
  name      String
  startDate DateTime       @db.Date
  endDate   DateTime       @db.Date
  status    PeriodStatus   @default(open)
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

enum PeriodStatus {
  open
  closed
}